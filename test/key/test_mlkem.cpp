/* vim: set tabstop=4 shiftwidth=4 softtabstop=4 expandtab smarttab : */
/**
 * @file {file}
 * @author Soo Han, Kim (princeb612.kr@gmail.com)
 * @desc
 *
 * Revision History
 * Date         Name                Description
 */

#include "sample.hpp"

void test_mlkem_keygen() {
#if OPENSSL_VERSION_NUMBER >= 0x30500000L
    return_t ret = errorcode_t::success;
    crypto_keychain keychain;
    crypto_key key;

    ret = keychain.add_mlkem(&key, NID_ML_KEM_512, keydesc("ML-KEM-512"));
    ret = keychain.add_mlkem(&key, NID_ML_KEM_768, keydesc("ML-KEM-768"));
    ret = keychain.add_mlkem(&key, NID_ML_KEM_1024, keydesc("ML-KEM-1024"));

    auto dump_crypto_key = [&](crypto_key_object *item, void *) -> void {
        auto kid = item->get_desc().get_kid_cstr();
        auto pkey = key.find(kid);
        _test_case.assert(nullptr != pkey, __FUNCTION__, "find %s", kid);

        auto kty = ktyof_evp_pkey(pkey);
        _test_case.assert(kty_mlkem == kty, __FUNCTION__, "kty %s", nameof_key_type(kty));

        _logger->write([&](basic_stream &bs) -> void {
            bs.println("\e[1;32m> kid \"%s\"\e[0m", item->get_desc().get_kid_cstr());
            dump_key(item->get_pkey(), &bs, 16, 3, dump_notrunc);
        });
    };
    key.for_each(dump_crypto_key, nullptr);
    _test_case.assert(3 == key.size(), __FUNCTION__, "add_mlkem");

    // and then encapsulate, decapsulate ... see example pqc
#else
    _test_case.test(not_supported, __FUNCTION__, "openssl 3.5 required");
#endif
}

void test_mlkem_keyuse(tls_group_t group, const binary_t &share) {
#if OPENSSL_VERSION_NUMBER >= 0x30500000L
    return_t ret = errorcode_t::success;
    crypto_keyexchange keyexchange;
    crypto_key key;

    crypto_advisor *advisor = crypto_advisor::get_instance();
    auto hint = advisor->hintof_tls_group(group);
    if (hint) {
        auto name = hint->name;

        ret = keyexchange.keystore(group, &key, "store", share);
        _test_case.test(ret, __FUNCTION__, "store %s", name);
        auto dump_crypto_key = [&](crypto_key_object *item, void *) -> void {
            auto kid = item->get_desc().get_kid_cstr();

            _logger->write([&](basic_stream &bs) -> void {
                bs.println("\e[1;32m> kid \"%s\"\e[0m", kid);
                dump_key(item->get_pkey(), &bs, 16, 3, dump_notrunc);
            });
        };
        key.for_each(dump_crypto_key, nullptr);

        binary_t keycapsule;
        binary_t sharedsecret;
        ret = keyexchange.encaps(group, share, keycapsule, sharedsecret);
        _test_case.test(ret, __FUNCTION__, "encaps %s", name);
    } else {
        _test_case.test(not_supported, __FUNCTION__, "unknown");
    }
#else
    _test_case.test(not_supported, __FUNCTION__, "openssl 3.5 required");
#endif
}

void test_mlkem_keyuse() {
    return_t ret = errorcode_t::success;
    struct testvector {
        tls_group_t group;
        const char *client_share;
    };
    testvector tv[] = {
        {
            tls_group_secp256r1mlkem768,
            "04973c742d203432ed7ae3b028609d24ae1a4638d1c920e85113d2a64a19e6ad31158e9525ca97a4db652002ee78cc97e57bda5d6fb9a3960dc1272f3d129556825ca432f12b1dd931"
            "6ed01a3b29c876ca285750e2caf0f817081a9c66e6cdfda79740b4cc4556429f017ec008c2619a355e0b6d7103471f5385d9f401fa05c055e34e6f540c59e113a3915e8e1646ee0539"
            "94065b81a72c3cdb88d755688b0038c6209fbf1125a25236bc38c7ff45b7d9a68c422747b2c4b56611ad85e295a7163b88e020a7b891345855a3d00bb291407c782675a9b372961106"
            "36878a890a0802536a01a9aa855e578ca8f3589452c47fec753391f41e8154c8203b1433347fbe63cb45a60c5540c0c1ccc0237335dec57fcd71ac112430575b18add14367bc127759"
            "5c25b757a9d39885ecc13cb187c05632e977c4d32441f6d04a190682acc79cbd75772d3c928b860ca022b3ab05c34ae3657879015fb189887591ba119fd33b2a6f26c739974ce26c93"
            "3b81597014868bf255df885600592faac1a9f135c59cb54a7a6b9875a83d84a05409d0683afb34b221073cc268f3e499ad310ada7b9db3e5929ccc3ddd04832d260f823c583609c5b7"
            "c27edf011deb419c5e0ba0810226ca9487e0e1146fc5b2dfc4869166c18ef2173628cd39a39cae728e40e0bd2ca20acf3bcb89c76394cc87d73c98d9642182a10048ea1d71370c9414"
            "832293557fd241878069e6f935592997f0397dd3dc54459075d1913cf178b6da217e0e2bcbe6eb26044423515babd0b356479502e659981e11c8c7181541116f1571ce463410584220"
            "60744d4e3c3976b65379d6c7dc576f1a037de1c202f2db4ee403799ce55def177f329282b9182ba1051ac64cc820bacfc05b0ef9fb5ff5117d9e1074e66b094f32b07a217249e35f2d"
            "776ebe594dc47ccfbf8c82621a750d564bae6c6e007411db707ee089574237bb8a92360bb6b3f84c7681c52780a867ac4a17b4a1a0ba03619b8b35a06843c3a891e999913dc26cd155"
            "5d1943a3b8384e1f5612ee2343c549add200393a114d9b101cea7336035a677040a203217de08289b759218a3c47eafc2ea05aad85d43729aab42d92b3f63a728db111223a2a054927"
            "3cf61591000426ba05a4daa171876c15b25ccdc9a3cf6203ba8c356a212d831032a66046aff210355cc75c31bef28ab65c464845495e40c27d1cec39873c632026bc54e227d3625873"
            "14c8f8ac68ec341b66d8068c430262d98498f31d470cc88841933033b7b04ca15356be45a89eb66b7a4d409c37e213890c2fcf310d497128d9ab9eeeb56377e83d3c6c935d9294dd64"
            "038cb3aae7c11e85b46ac5e372c9b1082424272bb76f5732006e230e6dc253c4469a8b8c2c743c17a8840dea2c3709a07867684de0b2672029a8124591aca8a3a20031e03c1cd3f27a"
            "b57b39aa88007a35622247be49433469470b08153388eb5dd294451b9b421329565c2b60ea19bede50c3c960120c619968e3b4f618b98a821a5622a349e777ed1c2e0af1a34af2c502"
            "099889b190a49b2710d7254bc73f4d151dc26b87221c6081300e62f72bb15549be817875181dd2f51090578ca1466c431b9d5080b8f3907b1907847a582d613c8086fc9960f05f14b1"
            "a987fb9091b7092575181d5534c6663599a516965658fec9b557f2a3a1c460beb29328fc81b6fa35b867ac91811c6fb3914b3eea73d3b8b6686b80a1106858573cadd3c5ec748e4515"
            "da14afaaf20607b7",
        },
        {
            tls_group_x25519mlkem768,
            "b94cc686147d95a83319193544e6bb0f4799e3d735ef9694ea1a48c68027a58c33f39481978831cac5305274828275618ee7bfea895f5618093f675cbac1a8eea0b6455591f176aa12"
            "4a848b656f23128460a5bf81512eb08b86218b56550b032c556f119065e2a99523bcafb25c4ed9841a42da73dc8b07e2dc87889c842c316f4d4baa911742d8e51f2c1ca759ab32652c"
            "cb4bcb226bc9bbb6f2000566461bd44e5e8c034a600597f55afd326d81c1aaf5d219ced1814169b0616ba1ba03cca40c8742f2437d2a4b65ca7e1694c14348147bb82d42a50433c89a"
            "801c76d1242c86398791016acac94d970a78a3170332a43d5a47738c6bb9efc8c6d736050760c0dd574422fc10f6153a77d94b1908828b0891cbd334faba4cc69493df3aaa2d8270ab"
            "b29c7270610f33a0062cc6bfd73157b216abfb8c16b43b4cac2f4ac96a79a75c5acc640ecb3471b77671e3aae6295e52fac6d3e3c87d925ee9d79cb0b3746fdbc818039e7d7666ef6b"
            "b1751643f7ea194ad0ada4634c5c450627a4755564241e9b61f28c2d27266409d01946c98045f1bc8f3b43c7eb86cde2732e674b3bb166cf3b0ce6a4c993b9cb4da594c17abe8e475e"
            "6b8b107342a4cdf106134c937bbabe5b3a03ee752d0b516cc0f395e03778bc155f4c8789ec532f218c3540e092f014ae2b0595eb7b1aa88852fd25aecce823c3d9bc2f80cb4c1c79ae"
            "d18fe63525c5f367c84b43027a17633b54b4469e2464ba7310c3023badc29362b846bb10b329e8926fbbcc47e12264f6471d45f7c81890aa95e4c58df34606d5b055507a1667afbf65"
            "66cf036d73550c5803b4178b474c82adb2220efc500ee54577fdb511b6b317f88a5a5e2b9e7f165101e0569de3620e20569c3b9c9cc80340f8caf000340f33c6dc114479662dd4fb4c"
            "046caa6b716d8077c7130ccb4b44c6d941a8b40548a3552367042cc480234b648717408b712627b3468557547a318cc96272c13ffabf3e92cb830aa3d7c747fe187ac5906c58d499e6"
            "00531cd3054f5cbff589c3cc5b602cb917a60a04f56535e8c8ab17ea5838b358b65a811395364e4ab2b277490e9a291430629a2a05bb91a172dc02deaa1bc9a98c1967a42a1a0fe66a"
            "8100bcca5c7197d3d03024d7770ef306dfb75a9b4026d2a3798d5b7a12c32bb58a858f0c47d9f55eda79a8fc8bbfe10a25bdc1755450734722842daab34144785de82e0746c5deb929"
            "86816883928e5ec06b6027453e89c9bd7712bc9336ae23b724c5071d36a251a1158f996d5c51b97c8737324cc95513b62ea84714d15b5753c0abb23fccec7b42835534ac7b7a993e1a"
            "348c17b6a267c470d7eb776283009c4708265223dd44075a1b3ffce42f824175199ccd593c5b00aa770aa5abbec29f17818d780bb20f9c6b6344be62d33ebfe011c8041602e0110550"
            "74e6221d8fe451d153baf9265b66a1b9847364fd3c4cc1ec70c2065c5bb83bf26513f80c7511069ed078166689a15587b37f7bbf41481064949491d5b415707b61663653e335a9bc7b"
            "ad256ab8bc4b25a38b78c2635f57327698bd59e3cc2aa26abac30f3e1108da4a7832195fecf16407ccb96b5356e5902d210a63727155a3556b3ed3e631078a1b023875f0b36365f168"
            "172cf45483e1783466deb47cfd8bd28f6dcbedfc2df9b9631bc1c6d58c77e0e2f5f1655a11283d367a6782680fb1105b",
        },
        {
            tls_group_secp384r1mlkem1024,
            "04ba586a806b666033f2c721d1b12f2b928da0b7e59d5f497209f785e9ee7cca686f561155d0cd90bc9cabeb189b015b765aef175be733dd3ffb6d5770b3f81755adea2486ee9fc5b0"
            "5326a3e543af3a44811f6fb98dc2383a2a6cd23715a3acc92c27040f8629f3a6bfb3c567fa93543a8621ea178725692311a6c00188c9d4f54be0762408a76f6c477bbba154fd619510"
            "b39d04b2b978036f310c5e0a913bc2e73528a885f287b44b5a871fb7632f74033dec99049a841643cc41cba9c3a072a1d23995047f44431f5b7142435443704ca74da42dca6c3c16ca"
            "a7b225654b7416e7d69515f5ad8727a76211b309773746562f8733bae098bb9d095605c75fc0231b12bcc88cb3ce55625301a88757421cf0c771ca80b444f00e6474c4c3d51e66f20e"
            "f9e607199789382747832952143989e588561af6ca91cb9f43a4294161c6ecab6a79bb29df386d83f6ad1413958654701b218f0cb034ed521142d75569d601bbb94a268888f6a781ef"
            "254e5d6b1e8f372ac2d51464d1530fdcb0799b448d7160aad1a9cc99822fda20476a3e31532edb93c2b8d089fad3304b696c58c62c7448c0174c70d6d29235b434341056bedc17b55b"
            "aba0f5b83edc5e452a02f2b15676babc49e71f5478591388a2de369c11ec9645c44dbc425fb8e5c2902b06ab66c23cf6c746a0077709b87828acc097a38679919000aa6648ae193cc5"
            "ddb167d8971090282684482fe15430c3f64f91734bf145c5d1897b0beca95ed118a3122b056947bd803f397948789bb1f1c051be7c2049856743369a8a802f20796f0d5c5c8fb332d9"
            "46a206f43a96d3858b559b3090a8a530bd8319b68af086d98054666a39c13c9fbe5006774a429cf1000925caaeb78f696492cd3b2104cb18ca543564c6892d342d1ae48f64678f1ba3"
            "0939377f8d9c981e6787cc4c4c97f136c7c31fc8d05c39dbaa9db6087d09454e7a116375b5a788a686c62186251048e89e44e595ab945388ab1bb164499579b002937cb78b060f0634"
            "93a228a789ad42376ce7e6cdb876c32b55a7c8e25c55d41cf39949b4eb94c8ba15b2b9688a853e1729087e8a12c625bdb608c474a53b31a67964451b2c69a2f04a1721c75d1fc36d4d"
            "41054510313879cab1734c1e47bc9b03709231abb29573349a52f06b9e54e66046e0a18010144d25023ad18a93d688ab832b66b62a5cf30b7fe51727fc4e113638a3cb2a633cad24b9"
            "8d86336b54e0ac1c868725292fe9a2b24b3575c1809eb42b3ccdda2c3041c63e8aae5c3682d27a78ead655b3095b725b6c5a217522f51465215a0e5a5835327bb5924ae3a97ae1379d"
            "b6f408fdc71c7a8a11b719a7596666b1920f6bc38d4e4228853396dca509a1b56aeae3982c57a5b967ab232595ae25c4c9914e94dc8add583e92f12dd2b41097d4a81dd878a0520f70"
            "9484c4b04f932c4967721aea96374cc57895414fedc3b4d6c46549d2af64987b748903b298b49f120a94228201bbc6daf260c1b5640ad02007c88f69139ae616560d9a656d5b6e6492"
            "5656850ff1c7bba573c560e59b178c8288e1101fb2a570f16b7a107318e4ae3780b41169c7d79063e85112a3652a42a210fe34179308488111195c576951892008a9cf841b8d06557f"
            "4957b52998a3298510f7880809885b280724d5242b634b092094bea9b8769ed73534904bdb2c4a1f3b550be1c030a2c8d881a9d3c6a0ba351b3edcc4c5f9aca042718ddb51ecaa5a97"
            "89768a139659d449a5e42bf78a38d5a21c90058bc18459e0f32a8caa2a07d60f1f6180ac79837ce18ea790bcae3b8420c83a04c06718c06929bbb1c401c10a6c6a5d94126ea85692fa"
            "4fd9e79c46a05816ba60e73a2bb87c56de4a5d2758c7f1c62e2b038b62809965854494993aa1f57110bb04da73322c7034db394a1437acc7534ad949b44b25c06230a3d720bcfef79d"
            "afaa8f842960bc27363363ce905178750ad06270404e8c55c2d38e446701d7662de2445fc9018134115eb66424c3c7103ca24915ba7f21224d79eb6db939c2dd414d1cd596e909ac78"
            "803adfc43e20e4586b06997f0b857079608cd2ca01e2768e24b5343a56b2f7a9194702f59ba8e8b04c96f6ba6536b515d7555de9a1eceb02b7133576b8027961852e6b00a8659d4810"
            "7af5b7c447a628e59a5c5c67576e034b91f2c11df8235d08ccba0ab38d4533d72570dd8875fe81a22649660446aac3d9661b4abba87204e20b66e9699f4818a387d8ad0df721ca26c6"
            "786cc7c5a8a595e0166b16ad7faa72da90bd63978739865ca6c1078eb11d21d9c9cbbfa8a40c6ac917d54a4f04efa59f152b5d287189e0915d8aa6",
        },
    };
    for (auto i = 0; i < RTL_NUMBER_OF(tv); i++) {
        auto item = tv + i;
        auto share = base16_decode(item->client_share);
        test_mlkem_keyuse(item->group, share);
    }
}

void test_mlkem() {
    _test_case.begin("ML-KEM");

    test_mlkem_keygen();
    test_mlkem_keyuse();
}
